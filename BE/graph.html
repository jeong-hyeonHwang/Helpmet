<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>자전거 · 도보 경로</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100%;
        width: calc(100% - 280px);
        float: left;
      }
      /* 지시문 패널 */
      #panel {
        width: 280px;
        height: 100%;
        float: right;
        box-sizing: border-box;
        padding: 12px;
        overflow-y: auto;
        border-left: 1px solid #ddd;
        font-family: "Noto Sans KR", sans-serif;
      }
      #panel h2 {
        margin: 4px 0 12px;
        font-size: 18px;
      }
      .inst {
        margin-bottom: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        line-height: 1.4;
      }
      .inst:hover {
        background: #f1f1f1;
      }
      .legend {
        background: white;
        padding: 6px 10px;
        border-radius: 4px;
        line-height: 1.3;
        font-size: 13px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
      }
      .legend span {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 4px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="panel">
      <h2>길 안내</h2>
      <div id="instructions"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
      // === 사용자 좌표 ===
      // const fromLat = 37.566675;
      // const fromLon = 126.9778217;
      // const toLat = 37.5701297;
      // const toLon = 126.9822352;
      // const fromLat = 37.568906214790566;
      // const fromLon = 126.98304075103842;
      // const toLat = 37.567976479065024;
      // const toLon = 126.98736773794369;

      const fromLat = 37.57039327958451;
      const fromLon = 126.98629196806978;
      const toLat = 37.566718894811586;
      const toLon = 126.98200838446921;


      const map = L.map("map").setView([fromLat, fromLon], 16);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // 범례
      const legend = L.control({ position: "bottomright" });
      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML =
          '<div><span style="background:#2ecc71"></span>자전거도로</div>' +
          '<div><span style="background:#3498db"></span>일반도로</div>' +
          '<div><span style="background:#ff4757"></span>출발/도착</div>' +
          '<div><span style="background:#ffa502"></span>지시문 포인트</div>';
        return div;
      };
      legend.addTo(map);

      async function drawRoute() {
        try {
          const res = await fetch(
            `http://127.0.0.1:8000/route/smart?from_lat=${fromLat}&from_lon=${fromLon}&to_lat=${toLat}&to_lon=${toLon}`
          );
          const data = await res.json();

          const boundsCoords = [];

          // 선 그리기
          data.route.forEach((seg) => {
            const lineCoords = [
              [seg.from.lat, seg.from.lon],
              [seg.to.lat, seg.to.lon],
            ];
            boundsCoords.push(...lineCoords);
            L.polyline(lineCoords, {
              color: seg.is_cycleway ? "#2ecc71" : "#3498db",
              weight: 5,
              opacity: 0.8,
            }).addTo(map);
          });

          // 출발/도착 마커
          const startMarker = L.marker([fromLat, fromLon], {
            icon: L.icon({
              iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
            }),
          })
            .addTo(map)
            .bindPopup("출발지");

          const endMarker = L.marker([toLat, toLon], {
            icon: L.icon({
              iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-red.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
            }),
          })
            .addTo(map)
            .bindPopup("도착지");

          // 지시문 마커 + 패널
          const instContainer = document.getElementById("instructions");
          data.instructions.forEach((inst, idx) => {
            const { lat, lon } = inst.location;
            const mk = L.marker([lat, lon], {
              icon: L.divIcon({
                className: "inst-icon",
                html: `<div style="width:18px;height:18px;border-radius:50%;background:#ffa502;color:#fff;font-size:11px;text-align:center;line-height:18px;">${idx + 1}</div>`,
                iconSize: [18, 18],
                iconAnchor: [9, 9],
              }),
            })
              .addTo(map)
              .bindPopup(inst.message);

            // 패널 항목
            const div = document.createElement("div");
            div.className = "inst";
            div.textContent = `${idx + 1}. ${inst.message}`;
            div.onclick = () => {
              map.setView([lat, lon], 18);
              mk.openPopup();
            };
            instContainer.appendChild(div);
          });

          // View bounds
          if (boundsCoords.length) {
            map.fitBounds(boundsCoords);
          }
        } catch (e) {
          console.error(e);
          alert("경로를 불러오지 못했습니다.");
        }
      }

      drawRoute();
    </script>
  </body>
</html>