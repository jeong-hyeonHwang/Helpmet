<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>자전거 · 도보 경로</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100%;
        width: calc(100% - 280px);
        float: left;
      }
      /* 지시문 패널 */
      #panel {
        width: 280px;
        height: 100%;
        float: right;
        box-sizing: border-box;
        padding: 12px;
        overflow-y: auto;
        border-left: 1px solid #ddd;
        font-family: "Noto Sans KR", sans-serif;
      }
      #panel h2 {
        margin: 4px 0 12px;
        font-size: 18px;
      }
      .inst {
        margin-bottom: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        line-height: 1.4;
      }
      .inst:hover {
        background: #f1f1f1;
      }
      .legend {
        background: white;
        padding: 6px 10px;
        border-radius: 4px;
        line-height: 1.3;
        font-size: 13px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
      }
      .legend span {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 4px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="panel">
      <h2>길 안내</h2>
    
      <!-- 📌 위경도 입력 -->
      <div style="margin-bottom: 10px;">
        <input type="number" id="latInput" placeholder="위도" step="any" style="width: 80px;" />
        <input type="number" id="lngInput" placeholder="경도" step="any" style="width: 80px;" />
        <button onclick="addMarkerFromInput()">마커 추가</button>
      </div>
    
      <!-- 📍 최근 마커 2개로 API 요청 -->
      <button onclick="requestRouteFromMarkers()" style="margin-bottom: 10px;">📍 최근 마커로 경로 요청</button>
    
      <div id="instructions"></div>
    </div>    

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        const fromLat = 37.57039327958451;
        const fromLon = 126.98629196806978;

        const map = L.map("map").setView([fromLat, fromLon], 16);
      
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);
      
        const markers = [];
      
        map.on("click", function (e) {
          const lat = e.latlng.lat;
          const lng = e.latlng.lng;
      
          const marker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`위도: ${lat.toFixed(5)}<br>경도: ${lng.toFixed(5)}`)
            .openPopup();
      
          marker.on("click", function () {
            map.removeLayer(marker);
            const index = markers.indexOf(marker);
            if (index !== -1) markers.splice(index, 1);
          });
      
          if (markers.length >= 2) {
            const old = markers.shift();
            map.removeLayer(old);
          }
      
          markers.push(marker);
        });
      
        // 버튼 클릭 시 API 요청
        function requestRouteFromMarkers() {
          if (markers.length < 2) {
            alert("마커를 두 개 찍어주세요!");
            return;
          }
      
          const [from, to] = markers.map(m => m.getLatLng());
          drawRoute(from.lat, from.lng, to.lat, to.lng);
        }
      
        // 수정된 drawRoute 함수
        async function drawRoute(fromLat, fromLon, toLat, toLon) {
          try {
            const res = await fetch(
              `http://127.0.0.1:8000/route/walk?from_lat=${fromLat}&from_lon=${fromLon}&to_lat=${toLat}&to_lon=${toLon}`
            // `http://127.0.0.1:8000/route/bike?lat=${fromLat}&lon=${fromLon}&to_lat=${toLat}&to_lon=${toLon}&max_minutes=30`
            );
            const data = await res.json();
            console.log(data);
      
            const boundsCoords = [];
      
            // 기존 라인 제거 로직 추가 고려 가능
            data.route.forEach((seg) => {
              const lineCoords = [
                [seg.from.lat, seg.from.lon],
                [seg.to.lat, seg.to.lon],
              ];
              boundsCoords.push(...lineCoords);
              L.polyline(lineCoords, {
                color: seg.is_cycleway ? "#2ecc71" : "#3498db",
                weight: 5,
                opacity: 0.8,
              }).addTo(map);
            });
      
            const instContainer = document.getElementById("instructions");
            instContainer.innerHTML = ""; // 이전 지시문 초기화
      
            data.instructions.forEach((inst, idx) => {
              const { lat, lon } = inst.location;
              const mk = L.marker([lat, lon], {
                icon: L.divIcon({
                  className: "inst-icon",
                  html: `<div style="width:18px;height:18px;border-radius:50%;background:#ffa502;color:#fff;font-size:11px;text-align:center;line-height:18px;">${idx + 1}</div>`,
                  iconSize: [18, 18],
                  iconAnchor: [9, 9],
                }),
              })
                .addTo(map)
                .bindPopup(inst.message);
      
              const div = document.createElement("div");
              div.className = "inst";
              div.textContent = `${idx + 1}. ${inst.message}`;
              div.onclick = () => {
                map.setView([lat, lon], 18);
                mk.openPopup();
              };
              instContainer.appendChild(div);
            });
      
            if (boundsCoords.length) {
              map.fitBounds(boundsCoords);
            }
          } catch (e) {
            console.error(e);
            alert("경로를 불러오지 못했습니다.");
          }
        }
      
        // 초기 경로는 제거 (선택적)
        // drawRoute(fromLat, fromLon, toLat, toLon);
      </script>
      <script>
        function addMarkerFromInput() {
          const lat = parseFloat(document.getElementById("latInput").value);
          const lng = parseFloat(document.getElementById("lngInput").value);
      
          if (isNaN(lat) || isNaN(lng)) {
            alert("올바른 위도와 경도를 입력해주세요.");
            return;
          }
      
          map.setView([lat, lng], 17);
      
          const marker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`위도: ${lat.toFixed(5)}<br>경도: ${lng.toFixed(5)}`)
            .openPopup();
      
          marker.on("click", function () {
            map.removeLayer(marker);
            const index = markers.indexOf(marker);
            if (index !== -1) markers.splice(index, 1);
          });
      
          if (markers.length >= 2) {
            const old = markers.shift();
            map.removeLayer(old);
          }
      
          markers.push(marker);
        }
      </script>      
  </body>
</html>