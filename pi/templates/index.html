<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HELPMET Streaming</title>
  <style>
    body { margin: 0; background: #000; width:100vw; height: 100vh; }
    video { width: 100%; object-fit: contain; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>
  <script>
  const video = document.getElementById("video");

  let ws = null;
  let pc = null;


  let isCleaningUp = false;
  let reconnectPending = false;
  
  function cleanup() {
    console.log("ðŸ§¹ cleanup ì‹œìž‘");
    isCleaningUp = true;

    try {
      if (pc) {
        pc.close();
        console.log("âœ… RTCPeerConnection ë‹«íž˜");
      }
    } catch (e) {
      console.warn("RTCPeerConnection close ì‹¤íŒ¨", e);
    }
    pc = null;

    try {
      if (ws) {
        ws.close();
        console.log("âœ… WebSocket ë‹«íž˜");
      }
    } catch (e) {
      console.warn("WebSocket close ì‹¤íŒ¨", e);
    }
    ws = null;

    // âœ… cleanup ì´í›„ ë¦¬ì†ŒìŠ¤ ì™„ì „ í•´ì œ ì‹œê°„ í™•ë³´
    setTimeout(() => {
      isCleaningUp = false;
      console.log("âœ… cleanup ì™„ë£Œ");

      if (reconnectPending) {
        reconnectPending = false;
        console.log("â³ ëŒ€ê¸° ì¤‘ì´ë˜ ìž¬ì—°ê²° ì‹¤í–‰");
        safeStart();
      }
    }, 500); // âœ… ìµœì†Œ 500msëŠ” ê¸°ë‹¤ë ¤ì•¼ Android WebView ë¦¬ì†ŒìŠ¤ê°€ ì™„ì „ížˆ í•´ì œë¨
  }


 function safeStart() {
    if (isCleaningUp) {
      console.log("ðŸ•’ cleanup ì¤‘ì´ë¯€ë¡œ ìž¬ì—°ê²° ëŒ€ê¸°");
      reconnectPending = true;
      return;
    }

    setupWebSocket();
    setupWebRTC();
  }

  function setupWebSocket() {
    const wsUrl = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws`;
    ws = new WebSocket(wsUrl);

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      console.log("WS ë©”ì‹œì§€ ìˆ˜ì‹ :", data);
    };

    ws.onclose = () => {
      setTimeout(safeStart, 2000);
    };
  }

  async function setupWebRTC() {
    pc = new RTCPeerConnection();
    pc.addTransceiver("video", { direction: "recvonly" });

    pc.ontrack = (event) => {
        video.srcObject = event.streams[0];
  	video.play()
    };

    pc.onconnectionstatechange = () => {
      if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
        cleanup();
        reconnectPending = true;
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    const res = await fetch("/offer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        sdp: pc.localDescription.sdp,
        type: pc.localDescription.type
      })
    });
    const answer = await res.json();
    await pc.setRemoteDescription(answer);
  }

  safeStart();
</script>

</body>
</html>
